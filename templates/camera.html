{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-12">

    <!-- Header -->
    <header class="text-center mb-10 animate-fade-in-down">
        <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-blue-500">Live Anomaly Detection</h1>
        <p class="text-xl text-gray-400 mt-3">Monitoring Real-Time Camera Feed for Irregularities</p>
    </header>

    <!-- Camera Feed Section -->
    <div class="max-w-5xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-2 border border-gray-700 animate-fade-in-up" style="animation-delay: 0.3s;">
        <div class="relative">
            <!-- The actual camera feed image -->
            <img id="camera-feed" src="https://placehold.co/1280x720/000000/333333?text=Connecting+to+feed..." alt="Camera Feed" class="w-full h-auto rounded-lg">
            
            <!-- Canvas for drawing bounding boxes and labels -->
            <canvas id="bbox-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>

            <!-- Status Indicator -->
            <div class="absolute top-4 left-4 flex items-center space-x-2">
                <div id="status-light" class="w-4 h-4 rounded-full bg-yellow-500 animate-pulse"></div>
                <div id="status-text" class="font-semibold text-white bg-black/50 px-3 py-1 rounded-full">Connecting...</div>
            </div>

            <!-- Anomaly Status -->
            <div id="anomaly-status" class="absolute top-4 right-4 font-semibold text-white bg-black/50 px-3 py-1 rounded-full transition-colors duration-300">
                Status: Normal
            </div>

            <!-- Total Anomaly Count -->
            <div id="anomaly-count" class="absolute bottom-4 right-4 font-semibold text-white bg-black/50 px-3 py-1 rounded-full transition-colors duration-300">
                Total Anomalies: 0
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fade-in-down { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-down { animation: fade-in-down 0.8s ease-out forwards; }
    .animate-fade-in-up { animation: fade-in-up 0.8s ease-out forwards; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const feed = document.getElementById("camera-feed");
    const statusLight = document.getElementById("status-light");
    const statusText = document.getElementById("status-text");
    const anomalyStatus = document.getElementById("anomaly-status");
    const anomalyCountElem = document.getElementById("anomaly-count");
    const canvas = document.getElementById("bbox-canvas");
    const ctx = canvas.getContext("2d");

    const ws = new WebSocket(`ws://${location.host}/ws/camera_feed`);

    ws.onopen = function() {
        statusLight.classList.remove("bg-yellow-500", "animate-pulse");
        statusLight.classList.add("bg-green-500");
        statusText.textContent = "Connected";
    };

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        // Update camera feed image
        feed.src = `data:image/jpeg;base64,${data.frame}`;

        // Get image dimensions to scale canvas
        const imgWidth = feed.naturalWidth;
        const imgHeight = feed.naturalHeight;

        // Set canvas dimensions to match the image
        canvas.width = imgWidth;
        canvas.height = imgHeight;

        // Clear previous drawings
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Update anomaly status
        if (data.anomaly && data.bboxes && data.bboxes.length > 0) {
            anomalyStatus.textContent = "Status: Anomaly Detected!";
            anomalyStatus.classList.add("bg-red-500");

            // Draw bounding boxes and labels
            data.bboxes.forEach(bbox => {
                const [x1, y1, x2, y2] = bbox;
                const width = x2 - x1;
                const height = y2 - y1;

                // Rectangle
                ctx.strokeStyle = "red";
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, width, height);
            });
        } else {
            anomalyStatus.textContent = "Status: Normal";
            anomalyStatus.classList.remove("bg-red-500");
        }

        // Update total anomalies
        if (data.total_anomalies !== undefined) {
            anomalyCountElem.textContent = `Total Anomalies: ${data.total_anomalies}`;
        } else if (data.count !== undefined) {
            anomalyCountElem.textContent = `Total Anomalies: ${data.count}`;
        } else {
            anomalyCountElem.textContent = `Total Anomalies: 0`;
        }
    };

    ws.onclose = function() {
        statusLight.classList.remove("bg-green-500", "bg-yellow-500");
        statusLight.classList.add("bg-red-500");
        statusText.textContent = "Disconnected";
    };

    ws.onerror = function(error) {
        console.error("WebSocket error:", error);
        statusLight.classList.remove("bg-green-500", "bg-yellow-500");
        statusLight.classList.add("bg-red-500");
        statusText.textContent = "Error";
    };
});
</script>
{% endblock %}
